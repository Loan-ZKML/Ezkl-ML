#!/usr/bin/env bash

# Find staged Rust files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$')

if [[ -z "$STAGED_FILES" ]]; then
  # No Rust files staged, continue commit
  exit 0
fi

# Run clippy on the changed files:
echo "Running cargo clippy..."
cargo clippy --workspace --no-deps -- -D warnings

# Check if cargo clippy found any warnings
if [[ $? -ne 0 ]]; then
  echo "‚ùå Commit aborted. Fix the clippy warnings above, stage the changes, and commit again."
  exit 1
fi

# Run cargo fmt on staged files
echo "Running cargo fmt on staged Rust files..."

# Format each staged Rust file
cargo fmt --quiet -- $STAGED_FILES

# Check if cargo fmt modified any staged files
CHANGED_FILES=$(git diff --name-only --diff-filter=M $STAGED_FILES)

if [[ -n "$CHANGED_FILES" ]]; then
  echo "üö® Cargo fmt modified files:"
  echo "$CHANGED_FILES"
  echo ""
  echo "‚ùå Commit aborted. Review the formatting changes above, stage them, and commit again."
  exit 1
fi

# Everything looks good
exit 0
